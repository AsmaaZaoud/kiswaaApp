<<<<<<< HEAD
{"version":3,"file":"MetroDevServer.js","names":["getExpoMetroConfig","projectRoot","logger","unversioned","importExpoMetroConfigFromProject","unversionedVersion","require","version","info","tag","chalk","gray","bold","runMetroDevServerAsync","options","Metro","importMetroFromProject","reporter","LogReporter","ExpoMetroConfig","metroConfig","loadAsync","middleware","attachToServer","messageSocketEndpoint","eventsSocketEndpoint","websocketEndpoints","createDevServerMiddleware","port","server","watchFolders","customEnhanceMiddleware","enhanceMiddleware","metroMiddleware","use","runServer","hmrEnabled","messageSocket","eventsSocket","reportEvent","nextBuildID","bundleAsync","expoConfig","bundles","metro","Server","importMetroServerFromProject","config","buildID","metroServer","runMetro","watch","buildAsync","bundle","isHermes","isEnableHermesManaged","platform","bundleOptions","DEFAULT_BUNDLE_OPTIONS","bundleType","entryFile","entryPoint","dev","minify","inlineSourceMap","sourceMapUrl","createModuleIdFactory","serializer","onProgress","transformedFileCount","totalFileCount","quiet","update","type","bundleDetails","code","map","build","assets","getAssets","maybeAddHermesBundleAsync","bundleOutput","isHermesManaged","paths","getConfigFilePaths","configFilePath","dynamicConfigPath","staticConfigPath","maybeThrowFromInconsistentEngineAsync","platformTag","ios","android","web","hermesBundleOutput","buildHermesBundleAsync","hermesBytecodeBundle","hbc","hermesSourcemap","sourcemap","intermediateOutputs","Promise","all","bundleOutputs","i","length","push","end","attachInspectorProxy","InspectorProxy","importInspectorProxyServerFromProject","inspectorProxy","addWebSocketListener","createWebSocketListeners","processRequest","bind"],"sources":["../src/MetroDevServer.ts"],"sourcesContent":["import type Log from '@expo/bunyan';\nimport { ExpoConfig, getConfigFilePaths } from '@expo/config';\nimport type { LoadOptions } from '@expo/metro-config';\nimport chalk from 'chalk';\nimport type { Server as ConnectServer } from 'connect';\nimport http from 'http';\nimport type Metro from 'metro';\n\nimport {\n  buildHermesBundleAsync,\n  isEnableHermesManaged,\n  maybeThrowFromInconsistentEngineAsync,\n} from './HermesBundler';\nimport LogReporter from './LogReporter';\nimport {\n  importExpoMetroConfigFromProject,\n  importInspectorProxyServerFromProject,\n  importMetroFromProject,\n  importMetroServerFromProject,\n} from './metro/importMetroFromProject';\nimport { createDevServerMiddleware } from './middleware/devServerMiddleware';\n\nexport type MetroDevServerOptions = LoadOptions & {\n  logger: Log;\n  quiet?: boolean;\n  unversioned?: boolean;\n};\nexport type BundleOptions = {\n  entryPoint: string;\n  platform: 'android' | 'ios' | 'web';\n  dev?: boolean;\n  minify?: boolean;\n  sourceMapUrl?: string;\n};\nexport type BundleAssetWithFileHashes = Metro.AssetData & {\n  fileHashes: string[]; // added by the hashAssets asset plugin\n};\nexport type BundleOutput = {\n  code: string;\n  map: string;\n  hermesBytecodeBundle?: Uint8Array;\n  hermesSourcemap?: string;\n  assets: readonly BundleAssetWithFileHashes[];\n};\nexport type MessageSocket = {\n  broadcast: (method: string, params?: Record<string, any> | undefined) => void;\n};\n\nfunction getExpoMetroConfig(\n  projectRoot: string,\n  { logger, unversioned }: Pick<MetroDevServerOptions, 'logger' | 'unversioned'>\n): typeof import('@expo/metro-config') {\n  if (!unversioned) {\n    try {\n      return importExpoMetroConfigFromProject(projectRoot);\n    } catch {\n      // If expo isn't installed, use the unversioned config and warn about installing expo.\n    }\n  }\n\n  const unversionedVersion = require('@expo/metro-config/package.json').version;\n  logger.info(\n    { tag: 'expo' },\n    chalk.gray(\n      `\\u203A Unversioned ${chalk.bold`@expo/metro-config@${unversionedVersion}`} is being used. Bundling apps may not work as expected, and is subject to breaking changes. Install ${chalk.bold`expo`} or set the app.json sdkVersion to use a stable version of @expo/metro-config.`\n    )\n  );\n\n  return require('@expo/metro-config');\n}\n\nexport async function runMetroDevServerAsync(\n  projectRoot: string,\n  options: MetroDevServerOptions\n): Promise<{\n  server: http.Server;\n  middleware: any;\n  messageSocket: MessageSocket;\n}> {\n  const Metro = importMetroFromProject(projectRoot);\n\n  const reporter = new LogReporter(options.logger);\n\n  const ExpoMetroConfig = getExpoMetroConfig(projectRoot, options);\n\n  const metroConfig = await ExpoMetroConfig.loadAsync(projectRoot, { reporter, ...options });\n\n  const {\n    middleware,\n    attachToServer,\n\n    // RN +68 -- Expo SDK +45\n    messageSocketEndpoint,\n    eventsSocketEndpoint,\n    websocketEndpoints,\n  } = createDevServerMiddleware(projectRoot, {\n    port: metroConfig.server.port,\n    watchFolders: metroConfig.watchFolders,\n    logger: options.logger,\n  });\n\n  const customEnhanceMiddleware = metroConfig.server.enhanceMiddleware;\n  // @ts-ignore can't mutate readonly config\n  metroConfig.server.enhanceMiddleware = (metroMiddleware: any, server: Metro.Server) => {\n    if (customEnhanceMiddleware) {\n      metroMiddleware = customEnhanceMiddleware(metroMiddleware, server);\n    }\n    return middleware.use(metroMiddleware);\n  };\n\n  const server = await Metro.runServer(metroConfig, {\n    hmrEnabled: true,\n    websocketEndpoints,\n  });\n\n  if (attachToServer) {\n    // Expo SDK 44 and lower\n    const { messageSocket, eventsSocket } = attachToServer(server);\n    reporter.reportEvent = eventsSocket.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket,\n    };\n  } else {\n    // RN +68 -- Expo SDK +45\n    reporter.reportEvent = eventsSocketEndpoint.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket: messageSocketEndpoint,\n      // debuggerProxyEndpoint,\n    };\n  }\n}\n\nlet nextBuildID = 0;\n\n// TODO: deprecate options.target\nexport async function bundleAsync(\n  projectRoot: string,\n  expoConfig: ExpoConfig,\n  options: MetroDevServerOptions,\n  bundles: BundleOptions[]\n): Promise<BundleOutput[]> {\n  const metro = importMetroFromProject(projectRoot);\n  const Server = importMetroServerFromProject(projectRoot);\n\n  const reporter = new LogReporter(options.logger);\n  const ExpoMetroConfig = getExpoMetroConfig(projectRoot, options);\n\n  const config = await ExpoMetroConfig.loadAsync(projectRoot, { reporter, ...options });\n  const buildID = `bundle_${nextBuildID++}`;\n\n  const metroServer = await metro.runMetro(config, {\n    watch: false,\n  });\n\n  const buildAsync = async (bundle: BundleOptions): Promise<BundleOutput> => {\n    const isHermes = isEnableHermesManaged(expoConfig, bundle.platform);\n    const bundleOptions: Metro.BundleOptions = {\n      ...Server.DEFAULT_BUNDLE_OPTIONS,\n      bundleType: 'bundle',\n      platform: bundle.platform,\n      entryFile: bundle.entryPoint,\n      dev: bundle.dev ?? false,\n      minify: !isHermes && (bundle.minify ?? !bundle.dev),\n      inlineSourceMap: false,\n      sourceMapUrl: bundle.sourceMapUrl,\n      createModuleIdFactory: config.serializer.createModuleIdFactory,\n      onProgress: (transformedFileCount: number, totalFileCount: number) => {\n        if (!options.quiet) {\n          reporter.update({\n            buildID,\n            type: 'bundle_transform_progressed',\n            transformedFileCount,\n            totalFileCount,\n          });\n        }\n      },\n    };\n    reporter.update({\n      buildID,\n      type: 'bundle_build_started',\n      bundleDetails: {\n        bundleType: bundleOptions.bundleType,\n        platform: bundle.platform,\n        entryFile: bundle.entryPoint,\n        dev: bundle.dev ?? false,\n        minify: !isHermes && (bundle.minify ?? !bundle.dev),\n      },\n    });\n    const { code, map } = await metroServer.build(bundleOptions);\n    const assets = (await metroServer.getAssets(\n      bundleOptions\n    )) as readonly BundleAssetWithFileHashes[];\n    reporter.update({\n      buildID,\n      type: 'bundle_build_done',\n    });\n    return { code, map, assets };\n  };\n\n  const maybeAddHermesBundleAsync = async (\n    bundle: BundleOptions,\n    bundleOutput: BundleOutput\n  ): Promise<BundleOutput> => {\n    const { platform } = bundle;\n    const isHermesManaged = isEnableHermesManaged(expoConfig, platform);\n\n    const paths = getConfigFilePaths(projectRoot);\n    const configFilePath = paths.dynamicConfigPath ?? paths.staticConfigPath ?? 'app.json';\n    await maybeThrowFromInconsistentEngineAsync(\n      projectRoot,\n      configFilePath,\n      platform,\n      isHermesManaged\n    );\n\n    if (isHermesManaged) {\n      const platformTag = chalk.bold(\n        { ios: 'iOS', android: 'Android', web: 'Web' }[platform] || platform\n      );\n      options.logger.info(\n        { tag: 'expo' },\n        `ðŸ’¿ ${platformTag} Building Hermes bytecode for the bundle`\n      );\n      const hermesBundleOutput = await buildHermesBundleAsync(\n        projectRoot,\n        bundleOutput.code,\n        bundleOutput.map,\n        bundle.minify ?? !bundle.dev\n      );\n      bundleOutput.hermesBytecodeBundle = hermesBundleOutput.hbc;\n      bundleOutput.hermesSourcemap = hermesBundleOutput.sourcemap;\n    }\n    return bundleOutput;\n  };\n\n  try {\n    const intermediateOutputs = await Promise.all(bundles.map((bundle) => buildAsync(bundle)));\n    const bundleOutputs: BundleOutput[] = [];\n    for (let i = 0; i < bundles.length; ++i) {\n      // hermesc does not support parallel building even we spawn processes.\n      // we should build them sequentially.\n      bundleOutputs.push(await maybeAddHermesBundleAsync(bundles[i], intermediateOutputs[i]));\n    }\n    return bundleOutputs;\n  } finally {\n    metroServer.end();\n  }\n}\n\n/**\n * Attach the inspector proxy to a development server.\n * Inspector proxy is used for viewing the JS context in a browser.\n * This must be attached after the server is listening.\n * Attaching consists of pushing custom middleware and appending WebSockets to the server.\n *\n *\n * @param projectRoot\n * @param props.server dev server to add WebSockets to\n * @param props.middleware dev server middleware to add extra middleware to\n */\nexport function attachInspectorProxy(\n  projectRoot: string,\n  { server, middleware }: { server: http.Server; middleware: ConnectServer }\n) {\n  const { InspectorProxy } = importInspectorProxyServerFromProject(projectRoot);\n  const inspectorProxy = new InspectorProxy(projectRoot);\n  if ('addWebSocketListener' in inspectorProxy) {\n    // metro@0.59.0\n    inspectorProxy.addWebSocketListener(server);\n  } else if ('createWebSocketListeners' in inspectorProxy) {\n    // metro@0.66.0\n    // TODO: This isn't properly support without a ws router.\n    inspectorProxy.createWebSocketListeners(server);\n  }\n  // TODO(hypuk): Refactor inspectorProxy.processRequest into separate request handlers\n  // so that we could provide routes (/json/list and /json/version) here.\n  // Currently this causes Metro to give warning about T31407894.\n  // $FlowFixMe[method-unbinding] added when improving typing for this parameters\n  middleware.use(inspectorProxy.processRequest.bind(inspectorProxy));\n\n  return { inspectorProxy };\n}\n\nexport { LogReporter, createDevServerMiddleware };\nexport * from './middlwareMutations';\nexport * from './JsInspector';\n"],"mappings":"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"}
=======
{"version":3,"file":"MetroDevServer.js","names":["getExpoMetroConfig","projectRoot","logger","unversioned","importExpoMetroConfigFromProject","unversionedVersion","require","version","info","tag","chalk","gray","bold","runMetroDevServerAsync","options","Metro","importMetroFromProject","reporter","LogReporter","ExpoMetroConfig","metroConfig","loadAsync","middleware","attachToServer","messageSocketEndpoint","eventsSocketEndpoint","websocketEndpoints","createDevServerMiddleware","port","server","watchFolders","customEnhanceMiddleware","enhanceMiddleware","metroMiddleware","use","runServer","hmrEnabled","messageSocket","eventsSocket","reportEvent","nextBuildID","bundleAsync","expoConfig","bundles","metro","Server","importMetroServerFromProject","config","buildID","metroServer","runMetro","watch","buildAsync","bundle","bundleOptions","DEFAULT_BUNDLE_OPTIONS","bundleType","platform","entryFile","entryPoint","dev","minify","inlineSourceMap","sourceMapUrl","createModuleIdFactory","serializer","onProgress","transformedFileCount","totalFileCount","quiet","update","type","bundleDetails","code","map","build","assets","getAssets","maybeAddHermesBundleAsync","bundleOutput","isHermesManaged","isEnableHermesManaged","paths","getConfigFilePaths","configFilePath","dynamicConfigPath","staticConfigPath","maybeThrowFromInconsistentEngineAsync","platformTag","ios","android","web","hermesBundleOutput","buildHermesBundleAsync","hermesBytecodeBundle","hbc","hermesSourcemap","sourcemap","intermediateOutputs","Promise","all","bundleOutputs","i","length","push","end","attachInspectorProxy","InspectorProxy","importInspectorProxyServerFromProject","inspectorProxy","addWebSocketListener","createWebSocketListeners","processRequest","bind"],"sources":["../src/MetroDevServer.ts"],"sourcesContent":["import type Log from '@expo/bunyan';\nimport { ExpoConfig, getConfigFilePaths } from '@expo/config';\nimport type { LoadOptions } from '@expo/metro-config';\nimport chalk from 'chalk';\nimport type { Server as ConnectServer } from 'connect';\nimport http from 'http';\nimport type Metro from 'metro';\n\nimport {\n  buildHermesBundleAsync,\n  isEnableHermesManaged,\n  maybeThrowFromInconsistentEngineAsync,\n} from './HermesBundler';\nimport LogReporter from './LogReporter';\nimport {\n  importExpoMetroConfigFromProject,\n  importInspectorProxyServerFromProject,\n  importMetroFromProject,\n  importMetroServerFromProject,\n} from './metro/importMetroFromProject';\nimport { createDevServerMiddleware } from './middleware/devServerMiddleware';\n\nexport type MetroDevServerOptions = LoadOptions & {\n  logger: Log;\n  quiet?: boolean;\n  unversioned?: boolean;\n};\nexport type BundleOptions = {\n  entryPoint: string;\n  platform: 'android' | 'ios' | 'web';\n  dev?: boolean;\n  minify?: boolean;\n  sourceMapUrl?: string;\n};\nexport type BundleAssetWithFileHashes = Metro.AssetData & {\n  fileHashes: string[]; // added by the hashAssets asset plugin\n};\nexport type BundleOutput = {\n  code: string;\n  map: string;\n  hermesBytecodeBundle?: Uint8Array;\n  hermesSourcemap?: string;\n  assets: readonly BundleAssetWithFileHashes[];\n};\nexport type MessageSocket = {\n  broadcast: (method: string, params?: Record<string, any> | undefined) => void;\n};\n\nfunction getExpoMetroConfig(\n  projectRoot: string,\n  { logger, unversioned }: Pick<MetroDevServerOptions, 'logger' | 'unversioned'>\n): typeof import('@expo/metro-config') {\n  if (!unversioned) {\n    try {\n      return importExpoMetroConfigFromProject(projectRoot);\n    } catch {\n      // If expo isn't installed, use the unversioned config and warn about installing expo.\n    }\n  }\n\n  const unversionedVersion = require('@expo/metro-config/package.json').version;\n  logger.info(\n    { tag: 'expo' },\n    chalk.gray(\n      `\\u203A Unversioned ${chalk.bold`@expo/metro-config@${unversionedVersion}`} is being used. Bundling apps may not work as expected, and is subject to breaking changes. Install ${chalk.bold`expo`} or set the app.json sdkVersion to use a stable version of @expo/metro-config.`\n    )\n  );\n\n  return require('@expo/metro-config');\n}\n\nexport async function runMetroDevServerAsync(\n  projectRoot: string,\n  options: MetroDevServerOptions\n): Promise<{\n  server: http.Server;\n  middleware: any;\n  messageSocket: MessageSocket;\n}> {\n  const Metro = importMetroFromProject(projectRoot);\n\n  const reporter = new LogReporter(options.logger);\n\n  const ExpoMetroConfig = getExpoMetroConfig(projectRoot, options);\n\n  const metroConfig = await ExpoMetroConfig.loadAsync(projectRoot, { reporter, ...options });\n\n  const {\n    middleware,\n    attachToServer,\n\n    // RN +68 -- Expo SDK +45\n    messageSocketEndpoint,\n    eventsSocketEndpoint,\n    websocketEndpoints,\n  } = createDevServerMiddleware(projectRoot, {\n    port: metroConfig.server.port,\n    watchFolders: metroConfig.watchFolders,\n    logger: options.logger,\n  });\n\n  const customEnhanceMiddleware = metroConfig.server.enhanceMiddleware;\n  // @ts-ignore can't mutate readonly config\n  metroConfig.server.enhanceMiddleware = (metroMiddleware: any, server: Metro.Server) => {\n    if (customEnhanceMiddleware) {\n      metroMiddleware = customEnhanceMiddleware(metroMiddleware, server);\n    }\n    return middleware.use(metroMiddleware);\n  };\n\n  const server = await Metro.runServer(metroConfig, {\n    hmrEnabled: true,\n    websocketEndpoints,\n  });\n\n  if (attachToServer) {\n    // Expo SDK 44 and lower\n    const { messageSocket, eventsSocket } = attachToServer(server);\n    reporter.reportEvent = eventsSocket.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket,\n    };\n  } else {\n    // RN +68 -- Expo SDK +45\n    reporter.reportEvent = eventsSocketEndpoint.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket: messageSocketEndpoint,\n      // debuggerProxyEndpoint,\n    };\n  }\n}\n\nlet nextBuildID = 0;\n\n// TODO: deprecate options.target\nexport async function bundleAsync(\n  projectRoot: string,\n  expoConfig: ExpoConfig,\n  options: MetroDevServerOptions,\n  bundles: BundleOptions[]\n): Promise<BundleOutput[]> {\n  const metro = importMetroFromProject(projectRoot);\n  const Server = importMetroServerFromProject(projectRoot);\n\n  const reporter = new LogReporter(options.logger);\n  const ExpoMetroConfig = getExpoMetroConfig(projectRoot, options);\n\n  const config = await ExpoMetroConfig.loadAsync(projectRoot, { reporter, ...options });\n  const buildID = `bundle_${nextBuildID++}`;\n\n  const metroServer = await metro.runMetro(config, {\n    watch: false,\n  });\n\n  const buildAsync = async (bundle: BundleOptions): Promise<BundleOutput> => {\n    const bundleOptions: Metro.BundleOptions = {\n      ...Server.DEFAULT_BUNDLE_OPTIONS,\n      bundleType: 'bundle',\n      platform: bundle.platform,\n      entryFile: bundle.entryPoint,\n      dev: bundle.dev ?? false,\n      minify: bundle.minify ?? !bundle.dev,\n      inlineSourceMap: false,\n      sourceMapUrl: bundle.sourceMapUrl,\n      createModuleIdFactory: config.serializer.createModuleIdFactory,\n      onProgress: (transformedFileCount: number, totalFileCount: number) => {\n        if (!options.quiet) {\n          reporter.update({\n            buildID,\n            type: 'bundle_transform_progressed',\n            transformedFileCount,\n            totalFileCount,\n          });\n        }\n      },\n    };\n    reporter.update({\n      buildID,\n      type: 'bundle_build_started',\n      bundleDetails: {\n        bundleType: bundleOptions.bundleType,\n        platform: bundle.platform,\n        entryFile: bundle.entryPoint,\n        dev: bundle.dev ?? false,\n        minify: bundle.minify ?? false,\n      },\n    });\n    const { code, map } = await metroServer.build(bundleOptions);\n    const assets = (await metroServer.getAssets(\n      bundleOptions\n    )) as readonly BundleAssetWithFileHashes[];\n    reporter.update({\n      buildID,\n      type: 'bundle_build_done',\n    });\n    return { code, map, assets };\n  };\n\n  const maybeAddHermesBundleAsync = async (\n    bundle: BundleOptions,\n    bundleOutput: BundleOutput\n  ): Promise<BundleOutput> => {\n    const { platform } = bundle;\n    const isHermesManaged = isEnableHermesManaged(expoConfig, platform);\n\n    const paths = getConfigFilePaths(projectRoot);\n    const configFilePath = paths.dynamicConfigPath ?? paths.staticConfigPath ?? 'app.json';\n    await maybeThrowFromInconsistentEngineAsync(\n      projectRoot,\n      configFilePath,\n      platform,\n      isHermesManaged\n    );\n\n    if (isHermesManaged) {\n      const platformTag = chalk.bold(\n        { ios: 'iOS', android: 'Android', web: 'Web' }[platform] || platform\n      );\n      options.logger.info(\n        { tag: 'expo' },\n        `ðŸ’¿ ${platformTag} Building Hermes bytecode for the bundle`\n      );\n      const hermesBundleOutput = await buildHermesBundleAsync(\n        projectRoot,\n        bundleOutput.code,\n        bundleOutput.map,\n        bundle.minify\n      );\n      bundleOutput.hermesBytecodeBundle = hermesBundleOutput.hbc;\n      bundleOutput.hermesSourcemap = hermesBundleOutput.sourcemap;\n    }\n    return bundleOutput;\n  };\n\n  try {\n    const intermediateOutputs = await Promise.all(bundles.map((bundle) => buildAsync(bundle)));\n    const bundleOutputs: BundleOutput[] = [];\n    for (let i = 0; i < bundles.length; ++i) {\n      // hermesc does not support parallel building even we spawn processes.\n      // we should build them sequentially.\n      bundleOutputs.push(await maybeAddHermesBundleAsync(bundles[i], intermediateOutputs[i]));\n    }\n    return bundleOutputs;\n  } finally {\n    metroServer.end();\n  }\n}\n\n/**\n * Attach the inspector proxy to a development server.\n * Inspector proxy is used for viewing the JS context in a browser.\n * This must be attached after the server is listening.\n * Attaching consists of pushing custom middleware and appending WebSockets to the server.\n *\n *\n * @param projectRoot\n * @param props.server dev server to add WebSockets to\n * @param props.middleware dev server middleware to add extra middleware to\n */\nexport function attachInspectorProxy(\n  projectRoot: string,\n  { server, middleware }: { server: http.Server; middleware: ConnectServer }\n) {\n  const { InspectorProxy } = importInspectorProxyServerFromProject(projectRoot);\n  const inspectorProxy = new InspectorProxy(projectRoot);\n  if ('addWebSocketListener' in inspectorProxy) {\n    // metro@0.59.0\n    inspectorProxy.addWebSocketListener(server);\n  } else if ('createWebSocketListeners' in inspectorProxy) {\n    // metro@0.66.0\n    // TODO: This isn't properly support without a ws router.\n    inspectorProxy.createWebSocketListeners(server);\n  }\n  // TODO(hypuk): Refactor inspectorProxy.processRequest into separate request handlers\n  // so that we could provide routes (/json/list and /json/version) here.\n  // Currently this causes Metro to give warning about T31407894.\n  // $FlowFixMe[method-unbinding] added when improving typing for this parameters\n  middleware.use(inspectorProxy.processRequest.bind(inspectorProxy));\n\n  return { inspectorProxy };\n}\n\nexport { LogReporter, createDevServerMiddleware };\nexport * from './middlwareMutations';\nexport * from './JsInspector';\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAKA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAKA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAMA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AA6QA;;AAAA;EAAA;EAAA;EAAA;EAAA;IAAA;IAAA;MAAA;IAAA;EAAA;AAAA;;AACA;;AAAA;EAAA;EAAA;EAAA;EAAA;IAAA;IAAA;MAAA;IAAA;EAAA;AAAA;;;;AAlPA,SAASA,kBAAT,CACEC,WADF,EAEE;EAAEC,MAAF;EAAUC;AAAV,CAFF,EAGuC;EACrC,IAAI,CAACA,WAAL,EAAkB;IAChB,IAAI;MACF,OAAO,IAAAC,0DAAA,EAAiCH,WAAjC,CAAP;IACD,CAFD,CAEE,MAAM,CACN;IACD;EACF;;EAED,MAAMI,kBAAkB,GAAGC,OAAO,CAAC,iCAAD,CAAP,CAA2CC,OAAtE;;EACAL,MAAM,CAACM,IAAP,CACE;IAAEC,GAAG,EAAE;EAAP,CADF,EAEEC,gBAAA,CAAMC,IAAN,CACG,sBAAqBD,gBAAA,CAAME,IAAK,sBAAqBP,kBAAmB,EAAE,uGAAsGK,gBAAA,CAAME,IAAK,MAAM,gFADpM,CAFF;EAOA,OAAON,OAAO,CAAC,oBAAD,CAAd;AACD;;AAEM,eAAeO,sBAAf,CACLZ,WADK,EAELa,OAFK,EAOJ;EACD,MAAMC,KAAK,GAAG,IAAAC,gDAAA,EAAuBf,WAAvB,CAAd;EAEA,MAAMgB,QAAQ,GAAG,KAAIC,sBAAJ,EAAgBJ,OAAO,CAACZ,MAAxB,CAAjB;EAEA,MAAMiB,eAAe,GAAGnB,kBAAkB,CAACC,WAAD,EAAca,OAAd,CAA1C;EAEA,MAAMM,WAAW,GAAG,MAAMD,eAAe,CAACE,SAAhB,CAA0BpB,WAA1B,EAAuC;IAAEgB,QAAF;IAAY,GAAGH;EAAf,CAAvC,CAA1B;EAEA,MAAM;IACJQ,UADI;IAEJC,cAFI;IAIJ;IACAC,qBALI;IAMJC,oBANI;IAOJC;EAPI,IAQF,IAAAC,gDAAA,EAA0B1B,WAA1B,EAAuC;IACzC2B,IAAI,EAAER,WAAW,CAACS,MAAZ,CAAmBD,IADgB;IAEzCE,YAAY,EAAEV,WAAW,CAACU,YAFe;IAGzC5B,MAAM,EAAEY,OAAO,CAACZ;EAHyB,CAAvC,CARJ;EAcA,MAAM6B,uBAAuB,GAAGX,WAAW,CAACS,MAAZ,CAAmBG,iBAAnD,CAvBC,CAwBD;;EACAZ,WAAW,CAACS,MAAZ,CAAmBG,iBAAnB,GAAuC,CAACC,eAAD,EAAuBJ,MAAvB,KAAgD;IACrF,IAAIE,uBAAJ,EAA6B;MAC3BE,eAAe,GAAGF,uBAAuB,CAACE,eAAD,EAAkBJ,MAAlB,CAAzC;IACD;;IACD,OAAOP,UAAU,CAACY,GAAX,CAAeD,eAAf,CAAP;EACD,CALD;;EAOA,MAAMJ,MAAM,GAAG,MAAMd,KAAK,CAACoB,SAAN,CAAgBf,WAAhB,EAA6B;IAChDgB,UAAU,EAAE,IADoC;IAEhDV;EAFgD,CAA7B,CAArB;;EAKA,IAAIH,cAAJ,EAAoB;IAClB;IACA,MAAM;MAAEc,aAAF;MAAiBC;IAAjB,IAAkCf,cAAc,CAACM,MAAD,CAAtD;IACAZ,QAAQ,CAACsB,WAAT,GAAuBD,YAAY,CAACC,WAApC;IAEA,OAAO;MACLV,MADK;MAELP,UAFK;MAGLe;IAHK,CAAP;EAKD,CAVD,MAUO;IACL;IACApB,QAAQ,CAACsB,WAAT,GAAuBd,oBAAoB,CAACc,WAA5C;IAEA,OAAO;MACLV,MADK;MAELP,UAFK;MAGLe,aAAa,EAAEb,qBAHV,CAIL;;IAJK,CAAP;EAMD;AACF;;AAED,IAAIgB,WAAW,GAAG,CAAlB,C,CAEA;;AACO,eAAeC,WAAf,CACLxC,WADK,EAELyC,UAFK,EAGL5B,OAHK,EAIL6B,OAJK,EAKoB;EACzB,MAAMC,KAAK,GAAG,IAAA5B,gDAAA,EAAuBf,WAAvB,CAAd;EACA,MAAM4C,MAAM,GAAG,IAAAC,sDAAA,EAA6B7C,WAA7B,CAAf;EAEA,MAAMgB,QAAQ,GAAG,KAAIC,sBAAJ,EAAgBJ,OAAO,CAACZ,MAAxB,CAAjB;EACA,MAAMiB,eAAe,GAAGnB,kBAAkB,CAACC,WAAD,EAAca,OAAd,CAA1C;EAEA,MAAMiC,MAAM,GAAG,MAAM5B,eAAe,CAACE,SAAhB,CAA0BpB,WAA1B,EAAuC;IAAEgB,QAAF;IAAY,GAAGH;EAAf,CAAvC,CAArB;EACA,MAAMkC,OAAO,GAAI,UAASR,WAAW,EAAG,EAAxC;EAEA,MAAMS,WAAW,GAAG,MAAML,KAAK,CAACM,QAAN,CAAeH,MAAf,EAAuB;IAC/CI,KAAK,EAAE;EADwC,CAAvB,CAA1B;;EAIA,MAAMC,UAAU,GAAG,MAAOC,MAAP,IAAwD;IAAA;;IACzE,MAAMC,aAAkC,GAAG,EACzC,GAAGT,MAAM,CAACU,sBAD+B;MAEzCC,UAAU,EAAE,QAF6B;MAGzCC,QAAQ,EAAEJ,MAAM,CAACI,QAHwB;MAIzCC,SAAS,EAAEL,MAAM,CAACM,UAJuB;MAKzCC,GAAG,iBAAEP,MAAM,CAACO,GAAT,qDAAgB,KALsB;MAMzCC,MAAM,oBAAER,MAAM,CAACQ,MAAT,2DAAmB,CAACR,MAAM,CAACO,GANQ;MAOzCE,eAAe,EAAE,KAPwB;MAQzCC,YAAY,EAAEV,MAAM,CAACU,YARoB;MASzCC,qBAAqB,EAAEjB,MAAM,CAACkB,UAAP,CAAkBD,qBATA;MAUzCE,UAAU,EAAE,CAACC,oBAAD,EAA+BC,cAA/B,KAA0D;QACpE,IAAI,CAACtD,OAAO,CAACuD,KAAb,EAAoB;UAClBpD,QAAQ,CAACqD,MAAT,CAAgB;YACdtB,OADc;YAEduB,IAAI,EAAE,6BAFQ;YAGdJ,oBAHc;YAIdC;UAJc,CAAhB;QAMD;MACF;IAnBwC,CAA3C;IAqBAnD,QAAQ,CAACqD,MAAT,CAAgB;MACdtB,OADc;MAEduB,IAAI,EAAE,sBAFQ;MAGdC,aAAa,EAAE;QACbhB,UAAU,EAAEF,aAAa,CAACE,UADb;QAEbC,QAAQ,EAAEJ,MAAM,CAACI,QAFJ;QAGbC,SAAS,EAAEL,MAAM,CAACM,UAHL;QAIbC,GAAG,kBAAEP,MAAM,CAACO,GAAT,uDAAgB,KAJN;QAKbC,MAAM,qBAAER,MAAM,CAACQ,MAAT,6DAAmB;MALZ;IAHD,CAAhB;IAWA,MAAM;MAAEY,IAAF;MAAQC;IAAR,IAAgB,MAAMzB,WAAW,CAAC0B,KAAZ,CAAkBrB,aAAlB,CAA5B;IACA,MAAMsB,MAAM,GAAI,MAAM3B,WAAW,CAAC4B,SAAZ,CACpBvB,aADoB,CAAtB;IAGArC,QAAQ,CAACqD,MAAT,CAAgB;MACdtB,OADc;MAEduB,IAAI,EAAE;IAFQ,CAAhB;IAIA,OAAO;MAAEE,IAAF;MAAQC,GAAR;MAAaE;IAAb,CAAP;EACD,CA1CD;;EA4CA,MAAME,yBAAyB,GAAG,OAChCzB,MADgC,EAEhC0B,YAFgC,KAGN;IAAA;;IAC1B,MAAM;MAAEtB;IAAF,IAAeJ,MAArB;IACA,MAAM2B,eAAe,GAAG,IAAAC,sCAAA,EAAsBvC,UAAtB,EAAkCe,QAAlC,CAAxB;IAEA,MAAMyB,KAAK,GAAG,IAAAC,4BAAA,EAAmBlF,WAAnB,CAAd;IACA,MAAMmF,cAAc,oCAAGF,KAAK,CAACG,iBAAT,yEAA8BH,KAAK,CAACI,gBAApC,uCAAwD,UAA5E;IACA,MAAM,IAAAC,sDAAA,EACJtF,WADI,EAEJmF,cAFI,EAGJ3B,QAHI,EAIJuB,eAJI,CAAN;;IAOA,IAAIA,eAAJ,EAAqB;MACnB,MAAMQ,WAAW,GAAG9E,gBAAA,CAAME,IAAN,CAClB;QAAE6E,GAAG,EAAE,KAAP;QAAcC,OAAO,EAAE,SAAvB;QAAkCC,GAAG,EAAE;MAAvC,EAA+ClC,QAA/C,KAA4DA,QAD1C,CAApB;;MAGA3C,OAAO,CAACZ,MAAR,CAAeM,IAAf,CACE;QAAEC,GAAG,EAAE;MAAP,CADF,EAEG,MAAK+E,WAAY,0CAFpB;MAIA,MAAMI,kBAAkB,GAAG,MAAM,IAAAC,uCAAA,EAC/B5F,WAD+B,EAE/B8E,YAAY,CAACN,IAFkB,EAG/BM,YAAY,CAACL,GAHkB,EAI/BrB,MAAM,CAACQ,MAJwB,CAAjC;MAMAkB,YAAY,CAACe,oBAAb,GAAoCF,kBAAkB,CAACG,GAAvD;MACAhB,YAAY,CAACiB,eAAb,GAA+BJ,kBAAkB,CAACK,SAAlD;IACD;;IACD,OAAOlB,YAAP;EACD,CAlCD;;EAoCA,IAAI;IACF,MAAMmB,mBAAmB,GAAG,MAAMC,OAAO,CAACC,GAAR,CAAYzD,OAAO,CAAC+B,GAAR,CAAarB,MAAD,IAAYD,UAAU,CAACC,MAAD,CAAlC,CAAZ,CAAlC;IACA,MAAMgD,aAA6B,GAAG,EAAtC;;IACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG3D,OAAO,CAAC4D,MAA5B,EAAoC,EAAED,CAAtC,EAAyC;MACvC;MACA;MACAD,aAAa,CAACG,IAAd,CAAmB,MAAM1B,yBAAyB,CAACnC,OAAO,CAAC2D,CAAD,CAAR,EAAaJ,mBAAmB,CAACI,CAAD,CAAhC,CAAlD;IACD;;IACD,OAAOD,aAAP;EACD,CATD,SASU;IACRpD,WAAW,CAACwD,GAAZ;EACD;AACF;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,SAASC,oBAAT,CACLzG,WADK,EAEL;EAAE4B,MAAF;EAAUP;AAAV,CAFK,EAGL;EACA,MAAM;IAAEqF;EAAF,IAAqB,IAAAC,+DAAA,EAAsC3G,WAAtC,CAA3B;EACA,MAAM4G,cAAc,GAAG,IAAIF,cAAJ,CAAmB1G,WAAnB,CAAvB;;EACA,IAAI,0BAA0B4G,cAA9B,EAA8C;IAC5C;IACAA,cAAc,CAACC,oBAAf,CAAoCjF,MAApC;EACD,CAHD,MAGO,IAAI,8BAA8BgF,cAAlC,EAAkD;IACvD;IACA;IACAA,cAAc,CAACE,wBAAf,CAAwClF,MAAxC;EACD,CAVD,CAWA;EACA;EACA;EACA;;;EACAP,UAAU,CAACY,GAAX,CAAe2E,cAAc,CAACG,cAAf,CAA8BC,IAA9B,CAAmCJ,cAAnC,CAAf;EAEA,OAAO;IAAEA;EAAF,CAAP;AACD"}
>>>>>>> main
